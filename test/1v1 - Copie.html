// Configuration initiale
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 600;

// Variables pour le jeu
const playerSpeed = 5;
const bulletSpeed = 7;
const shootCooldown = 500; // En millisecondes

const keys = {
    ArrowUp: false,
    ArrowDown: false,
    ArrowLeft: false,
    ArrowRight: false,
    Enter: false,
    w: false,
    s: false,
    a: false,
    d: false,
    ' ': false
};

const player1 = {
    x: 50,
    y: 300,
    width: 20,
    height: 20,
    dx: 0,
    dy: 0,
    canShoot: true,
    facing: 'right', // Peut être 'left', 'right', 'up', 'down', ou une combinaison
};

const player2 = {
    x: 720,
    y: 300,
    width: 20,
    height: 20,
    dx: 0,
    dy: 0,
    canShoot: true,
    facing: 'left',
};

const bullets = [];
const obstacles = [
    { x: 300, y: 200, width: 50, height: 100 },
    { x: 500, y: 350, width: 50, height: 100 }
];

// Gestion des entrées clavier
document.addEventListener('keydown', (e) => {
    if (keys.hasOwnProperty(e.key)) keys[e.key] = true;
});

document.addEventListener('keyup', (e) => {
    if (keys.hasOwnProperty(e.key)) keys[e.key] = false;
});

// Fonction pour tirer dans la direction que regarde le joueur
function shoot(player) {
    if (player.canShoot) {
        let bulletDx = 0;
        let bulletDy = 0;

        // Déterminer la direction du tir en fonction de "facing"
        if (player.facing === 'right') bulletDx = bulletSpeed;
        else if (player.facing === 'left') bulletDx = -bulletSpeed;
        else if (player.facing === 'up') bulletDy = -bulletSpeed;
        else if (player.facing === 'down') bulletDy = bulletSpeed;
        else if (player.facing === 'up-right') {
            bulletDx = bulletSpeed / Math.sqrt(2);
            bulletDy = -bulletSpeed / Math.sqrt(2);
        } else if (player.facing === 'up-left') {
            bulletDx = -bulletSpeed / Math.sqrt(2);
            bulletDy = -bulletSpeed / Math.sqrt(2);
        } else if (player.facing === 'down-right') {
            bulletDx = bulletSpeed / Math.sqrt(2);
            bulletDy = bulletSpeed / Math.sqrt(2);
        } else if (player.facing === 'down-left') {
            bulletDx = -bulletSpeed / Math.sqrt(2);
            bulletDy = bulletSpeed / Math.sqrt(2);
        }

        const bullet = {
            x: player.x + player.width / 2,
            y: player.y + player.height / 2,
            dx: bulletDx,
            dy: bulletDy
        };

        bullets.push(bullet);
        player.canShoot = false;
        setTimeout(() => (player.canShoot = true), shootCooldown);
    }
}

// Mise à jour des joueurs
function updatePlayer(player, upKey, downKey, leftKey, rightKey, shootKey) {
    player.dx = 0;
    player.dy = 0;

    if (keys[upKey]) {
        player.dy = -playerSpeed;
        player.facing = 'up';
    }
    if (keys[downKey]) {
        player.dy = playerSpeed;
        player.facing = 'down';
    }
    if (keys[leftKey]) {
        player.dx = -playerSpeed;
        player.facing = 'left';
    }
    if (keys[rightKey]) {
        player.dx = playerSpeed;
        player.facing = 'right';
    }

    // Combinaisons pour les diagonales
    if (keys[upKey] && keys[rightKey]) player.facing = 'up-right';
    if (keys[upKey] && keys[leftKey]) player.facing = 'up-left';
    if (keys[downKey] && keys[rightKey]) player.facing = 'down-right';
    if (keys[downKey] && keys[leftKey]) player.facing = 'down-left';

    if (keys[shootKey]) {
        shoot(player);
    }

    player.x += player.dx;
    player.y += player.dy;

    // Empêcher les joueurs de sortir de l'écran
    player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));
}

// Dessiner les joueurs
function drawPlayer(player, color) {
    ctx.fillStyle = color;
    ctx.fillRect(player.x, player.y, player.width, player.height);
}

// Dessiner les obstacles
function drawObstacles() {
    ctx.fillStyle = 'gray';
    obstacles.forEach((obstacle) => {
        ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
    });
}

// Dessiner les projectiles
function drawBullets() {
    ctx.fillStyle = 'black';
    bullets.forEach((bullet, index) => {
        bullet.x += bullet.dx;
        bullet.y += bullet.dy;

        // Vérifier les collisions avec les obstacles
        const hitObstacle = obstacles.some(
            (obs) =>
                bullet.x < obs.x + obs.width &&
                bullet.x + 5 > obs.x &&
                bullet.y < obs.y + obs.height &&
                bullet.y + 5 > obs.y
        );

        // Supprimer les balles hors de l'écran ou en collision
        if (
            bullet.x < 0 ||
            bullet.x > canvas.width ||
            bullet.y < 0 ||
            bullet.y > canvas.height ||
            hitObstacle
        ) {
            bullets.splice(index, 1);
        } else {
            ctx.fillRect(bullet.x, bullet.y, 5, 5);
        }
    });
}

// Fonction principale du jeu
function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dessiner les obstacles
    drawObstacles();

    // Mettre à jour les joueurs
    updatePlayer(player1, 'w', 's', 'a', 'd', ' ');
    updatePlayer(player2, 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter');

    // Dessiner les joueurs
    drawPlayer(player1, 'red');
    drawPlayer(player2, 'blue');

    // Dessiner les projectiles
    drawBullets();

    requestAnimationFrame(gameLoop);
}

// Réinitialiser le jeu
function resetGame() {
    player1.x = 50;
    player1.y = 300;
    player1.dx = 0;
    player1.dy = 0;
    player1.canShoot = true;
    player1.facing = 'right';

    player2.x = 720;
    player2.y = 300;
    player2.dx = 0;
    player2.dy = 0;
    player2.canShoot = true;
    player2.facing = 'left';

    bullets.length = 0;

    for (let key in keys) {
        keys[key] = false;
    }
}

// Lancer le jeu
resetGame();
gameLoop();
