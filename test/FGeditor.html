<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Level Editor - FG Layer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
        }

        h1 {
            text-align: center;
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .properties {
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #fff;
            margin-bottom: 20px;
        }

        .matrix {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .row {
            display: flex;
        }

        .tile {
            width: 20px;
            height: 20px;
            margin: 0;
            background-color: transparent;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .color-swatch {
            position: relative;
            width: 40px;
            height: 40px;
            cursor: pointer;
            margin: 5px;
            border: 1px solid #000;
        }

        .color-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-weight: bold;
            font-size: 12px;
        }

        .controls {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>XML Level Editor - FG Layer</h1>
        <button id="loadButton">Load XML Level</button>
        <div id="properties" class="properties"></div> 
        <div id="matrix" class="matrix"></div>
        <div class="color-palette" id="colorPalette"></div>
        <button id="saveButton">Save XML Level</button>
    </div>

    <script>
        let xmlDoc = null;
        let currentFileName = "";
        let isMouseDown = false;
        let currentColor = "#ffffff"; // Default color
        let currentColorValue = 0;

        document.getElementById("loadButton").addEventListener("click", loadLevel);
        document.getElementById("saveButton").addEventListener("click", saveLevel);
        document.addEventListener("mouseup", () => isMouseDown = false);

        function loadLevel() {
            const fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.accept = ".tmx";
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    currentFileName = file.name.replace(/\.xml$|\.tmx$/i, ""); 
                    reader.onload = (e) => {
                        const xmlContent = e.target.result;
                        parseXML(xmlContent);
                    };
                    reader.readAsText(file);
                }
            };
            fileInput.click();
        }

        function parseXML(xmlContent) {
            const parser = new DOMParser();
            xmlDoc = parser.parseFromString(xmlContent, "text/xml");

            displayProperties(xmlDoc);
            const fgLayer = Array.from(xmlDoc.getElementsByTagName("layer")).find(layer => layer.getAttribute("name").toLowerCase().includes("fg"));
            displayLayer(fgLayer);
            populateColorPalette(); // Color palette
        }

        function displayProperties(xmlDoc) {
            const propertiesDiv = document.getElementById("properties");
            propertiesDiv.innerHTML = ""; // Clear previous properties

            const properties = xmlDoc.getElementsByTagName("properties")[0];
            if (properties) {
                for (const prop of properties.children) {
                    const name = prop.getAttribute("name");
                    const value = prop.getAttribute("value");
                    propertiesDiv.innerHTML += `<p>${name}: ${value}</p>`;
                }
            } else {
                propertiesDiv.innerHTML = "<p>No properties found.</p>";
            }
        }

        function displayLayer(layer) {
            const matrixDiv = document.getElementById("matrix");
            matrixDiv.innerHTML = ""; // Clear previous content

            const width = parseInt(layer.getAttribute("width"), 10);
            const height = parseInt(layer.getAttribute("height"), 10);
            const dataElem = layer.getElementsByTagName("data")[0];

            if (dataElem && dataElem.textContent) {
                const tileData = dataElem.textContent.trim().split(",").map(Number);
                const matrix = Array.from({ length: height }, (_, i) =>
                    tileData.slice(i * width, (i + 1) * width)
                );

                matrix.forEach((row, rowIndex) => {
                    const rowDiv = document.createElement("div");
                    rowDiv.className = "row";
                    row.forEach((tile, colIndex) => {
                        const tileDiv = document.createElement("div");
                        tileDiv.className = "tile";
                        tileDiv.style.backgroundColor = getTileColor(tile);
                        tileDiv.dataset.value = tile;
                        tileDiv.dataset.row = rowIndex;
                        tileDiv.dataset.col = colIndex;

                        // Add listeners for filling while holding the click
                        tileDiv.addEventListener("mousedown", () => {
                            isMouseDown = true;
                            applyColorToTile(tileDiv, layer, width);
                        });
                        tileDiv.addEventListener("mouseover", () => {
                            if (isMouseDown) {
                                applyColorToTile(tileDiv, layer, width);
                            }
                        });

                        rowDiv.appendChild(tileDiv);
                    });
                    matrixDiv.appendChild(rowDiv);
                });
            }
        }

        function getTileColor(tileValue) {
            // Custom colors for the FG layer
            if (tileValue === 0) return "#ffffff"; // White for 0
            else if (tileValue === 84) return "#000000"; // Black for 84
            else if (tileValue === 74) return "#5592B0"; // Gray for 74
            else if (tileValue === 80) return "#ff0000";
            else if (tileValue === 81) return "#0000ff";
            else return "#cccccc"; // Light gray as default for other values
        }

        function populateColorPalette() {
            const colorPaletteDiv = document.getElementById("colorPalette");
            colorPaletteDiv.innerHTML = ""; // Clear previous palette

            const colors = [
                { value: 0, color: "#ffffff" },
                { value: 84, color: "#000000" },
                { value: 74, color: "#5592B0" },
                { value: 80, color: "#ff0000" },
                { value: 81, color: "#0000ff" }
            ];

            colors.forEach(({ value, color }) => {
                const swatch = document.createElement("div");
                swatch.className = "color-swatch";
                swatch.style.backgroundColor = color;
                swatch.dataset.value = value;

                const valueLabel = document.createElement("span");
                valueLabel.className = "color-value";
                valueLabel.innerText = value; // Display the value on the palette
                swatch.appendChild(valueLabel);

                swatch.addEventListener("click", () => {
                    currentColorValue = value;
                    currentColor = color;
                });
                colorPaletteDiv.appendChild(swatch);
            });
        }

        function applyColorToTile(tileDiv, layer, width) {
            const row = tileDiv.dataset.row;
            const col = tileDiv.dataset.col;
            const dataElem = layer.getElementsByTagName("data")[0];

            const tileData = dataElem.textContent.trim().split(",").map(Number);
            tileData[row * width + parseInt(col)] = currentColorValue;

            dataElem.textContent = tileData.join(",");
            tileDiv.style.backgroundColor = currentColor;
            tileDiv.dataset.value = currentColorValue;
        }

        function saveLevel() {
            const serializer = new XMLSerializer();
            const newXmlContent = serializer.serializeToString(xmlDoc);
            const modifiedFileName = `${currentFileName}.tmx`; 

            const blob = new Blob([newXmlContent], { type: "application/xml" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = modifiedFileName;
            a.click();
            URL.revokeObjectURL(url); 
        }
    </script>
</body>
</html>
